---
phase: 46-playground
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Makefile
  - website/package.json
  - website/astro.config.mjs
  - website/src/styles/custom.css
  - website/src/content/docs/playground.md
  - website/public/wasm/qseries-worker.js
  - website/src/pages/playground.astro
autonomous: true

must_haves:
  truths:
    - "User sees a terminal-style UI with monospace text at /playground/"
    - "User can type an expression and see the evaluated result"
    - "UI does not freeze during long computations (Worker-based execution)"
    - "Example dropdown preloads Rogers-Ramanujan, prodmake, theta, and relation examples"
    - "Loading spinner shown while Wasm downloads; computing indicator during evaluation"
    - "User can type prodmake(sum(q^(n^2)/aqprod(q,q,n),n,0,8),50) and get correct output"
  artifacts:
    - path: "website/public/wasm/qseries-worker.js"
      provides: "Web Worker that loads Emscripten Wasm module and evaluates expressions"
      contains: "importScripts"
    - path: "website/src/pages/playground.astro"
      provides: "Custom Starlight page with xterm.js terminal, input handling, Worker integration"
      min_lines: 100
    - path: "website/astro.config.mjs"
      provides: "Sidebar linking to /playground/ custom page"
      contains: "link: '/playground/'"
  key_links:
    - from: "website/src/pages/playground.astro"
      to: "website/public/wasm/qseries-worker.js"
      via: "new Worker('/wasm/qseries-worker.js')"
      pattern: "new Worker.*qseries-worker"
    - from: "website/public/wasm/qseries-worker.js"
      to: "website/public/wasm/qseries.js"
      via: "importScripts('/wasm/qseries.js') then createQSeries()"
      pattern: "importScripts.*qseries\\.js"
    - from: "website/astro.config.mjs"
      to: "/playground/ route"
      via: "sidebar link entry"
      pattern: "link.*playground"
---

<objective>
Build the complete interactive playground page where users can run q-series computations
in the browser using xterm.js + Wasm in a Web Worker.

Purpose: This is the crown jewel of the website — a live REPL that demonstrates the
q-series engine without any installation. Users can explore Rogers-Ramanujan identities,
product conversion, theta functions, and relation finding directly in the browser.

Output: A working /playground/ page with terminal UI, Web Worker Wasm execution,
example dropdown, loading states, and full line-editing support.
</objective>

<execution_context>
@C:/Users/ggarv/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ggarv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-playground/46-RESEARCH.md
@.planning/phases/43-wasm-compile/43-01-SUMMARY.md
@.planning/phases/44-starlight-scaffold/44-01-SUMMARY.md
@website/astro.config.mjs
@src/main_wasm.cpp
@Makefile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Playground infrastructure — deps, worker, config</name>
  <files>
    Makefile
    website/package.json
    website/astro.config.mjs
    website/src/styles/custom.css
    website/src/content/docs/playground.md
    website/public/wasm/qseries-worker.js
  </files>
  <action>
    **1. Install xterm.js dependencies in website/:**
    ```
    cd website && npm install @xterm/xterm@^5.5.0 @xterm/addon-fit@^0.10.0
    ```

    **2. Add Makefile target to copy Wasm files into website:**
    Add a `wasm-website` target after the existing `wasm` target that copies
    `build/wasm/qseries.js` and `build/wasm/qseries.wasm` into `website/public/wasm/`.
    Also add it to the `.PHONY` list.
    ```makefile
    wasm-website: build/wasm/qseries.js
    	mkdir -p website/public/wasm
    	cp build/wasm/qseries.js website/public/wasm/
    	cp build/wasm/qseries.wasm website/public/wasm/
    ```

    **3. Create the Web Worker script at `website/public/wasm/qseries-worker.js`:**
    This file goes in `public/` so it's served as-is (no Vite processing).
    It must:
    - On `{ type: 'init' }` message: call `importScripts('/wasm/qseries.js')`,
      then `await createQSeries({ locateFile: (path) => '/wasm/' + path })`,
      then post `{ type: 'ready', banner: Module.get_banner() }`.
    - Guard against double init with `let initialized = false`.
    - On `{ type: 'evaluate', expr }` message: call `Module.evaluate(expr)`,
      post `{ type: 'result', result }` on success or `{ type: 'error', error }` on failure.

    **4. Update sidebar in `website/astro.config.mjs`:**
    Replace the Playground sidebar group:
    ```javascript
    // FROM:
    {
      label: 'Playground',
      items: [
        { slug: 'playground' },
      ],
    },
    // TO:
    {
      label: 'Playground',
      items: [
        { label: 'Try it Online', link: '/playground/' },
      ],
    },
    ```

    **5. Delete the placeholder content doc:**
    Remove `website/src/content/docs/playground.md` — this route is now served
    by the custom page at `src/pages/playground.astro` (created in Task 2).

    **6. Add xterm.js CSS import to `website/src/styles/custom.css`:**
    At the top, after the katex import, add:
    ```css
    @import '@xterm/xterm/css/xterm.css';
    ```
  </action>
  <verify>
    - `cat website/package.json | grep "@xterm/xterm"` shows the dependency
    - `cat website/public/wasm/qseries-worker.js` exists and contains `importScripts`
    - `grep "link.*playground" website/astro.config.mjs` shows the updated sidebar link
    - `website/src/content/docs/playground.md` no longer exists
    - `grep "xterm" website/src/styles/custom.css` shows the CSS import
  </verify>
  <done>
    xterm.js deps installed, Worker script created in public/wasm/, Makefile has
    wasm-website copy target, sidebar links to custom page route, placeholder
    content doc removed, xterm CSS imported.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create playground.astro with full terminal UI</name>
  <files>
    website/src/pages/playground.astro
  </files>
  <action>
    Create `website/src/pages/playground.astro` — a custom Starlight page with
    the complete interactive terminal.

    **Page structure (Astro frontmatter + HTML):**
    ```astro
    ---
    import StarlightPage from '@astrojs/starlight/components/StarlightPage.astro';
    ---
    <StarlightPage frontmatter={{ title: 'Playground', description: 'Try qseries in your browser' }}>
      <!-- toolbar + terminal container + loading overlay -->
    </StarlightPage>
    ```

    **HTML layout:**
    - A `#playground-wrapper` div containing:
      - `#toolbar` div with:
        - `<select id="examples">` dropdown with options: "Load an example...",
          "Rogers-Ramanujan", "Product Conversion", "Theta Functions",
          "Finding Relations"
        - `<button id="run-example">Run</button>` to execute the selected example
        - `<span id="status">` for status text ("Loading...", "Ready", "Computing...")
      - `#terminal-container` div (height: 500px, border-radius: 8px, overflow: hidden)
      - `#loading-overlay` absolutely positioned over terminal, shown during Wasm download,
        with "Loading qseries engine..." text and a CSS-only spinner

    **CSS (in `<style>` block):**
    - `#playground-wrapper`: flex column, gap 0.5rem, full width
    - `#toolbar`: flex row, align-items center, gap 1rem, padding 0.5rem 0
    - `#toolbar select`: dark background (#1e1e3a), light text, border matching accent,
      border-radius 4px, padding 0.4rem 0.8rem, font-family inherit
    - `#toolbar button`: background var(--sl-color-accent), color white, border none,
      border-radius 4px, padding 0.4rem 1rem, cursor pointer, font-weight 600
    - `#terminal-container`: height 500px, border-radius 8px, overflow hidden,
      position relative, background #1a1a2e
    - `#loading-overlay`: position absolute, inset 0, display flex, align-items center,
      justify-content center, background #1a1a2e, color #e0e0e0, z-index 10,
      font-family monospace, flex-direction column, gap 1rem
    - `.spinner`: CSS-only spinning animation (border-based circle, 1.5s infinite linear)
    - `#status.computing`: color var(--sl-color-accent), with pulsing animation

    **JavaScript (in `<script>` block — Astro bundles this via Vite):**

    1. **Imports:**
       ```javascript
       import { Terminal } from '@xterm/xterm';
       import { FitAddon } from '@xterm/addon-fit';
       ```

    2. **Terminal initialization:**
       Create Terminal with these options:
       - `cursorBlink: true`
       - `fontSize: 14`
       - `fontFamily: 'ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace'`
       - Theme matching site's dark teal accent:
         ```
         background: '#1a1a2e', foreground: '#e0e0e0', cursor: '#00bcd4',
         cursorAccent: '#1a1a2e', selectionBackground: 'rgba(0,188,212,0.3)',
         cyan: '#00bcd4', green: '#66bb6a', red: '#ef5350', yellow: '#ffa726'
         ```
       - `scrollback: 5000`, `convertEol: true`
       Load FitAddon, call `term.open(container)`, then `fitAddon.fit()`.
       Add `window.addEventListener('resize', () => fitAddon.fit())`.

    3. **Worker lifecycle:**
       ```javascript
       const worker = new Worker('/wasm/qseries-worker.js');
       let isReady = false;
       let isComputing = false;
       ```
       On `worker.onmessage`:
       - `type: 'ready'`: hide loading overlay, write banner + blank line, write prompt
         `'qseries> '`, set `isReady = true`, update status to "Ready".
       - `type: 'result'`: if `result` non-empty, write `result + '\r\n'`. Write prompt.
         Set `isComputing = false`, update status to "Ready".
       - `type: 'error'`: write error in red (`\x1b[31m` + error + `\x1b[0m\r\n`).
         Write prompt. Set `isComputing = false`, update status to "Ready".
       On `worker.onerror`: write red error to terminal.
       Send `{ type: 'init' }` immediately.

    4. **Line-buffered input:**
       Variables: `let inputBuffer = ''`, `let cursorPos = 0`,
       `let history = []`, `let historyIndex = 0`.
       
       `term.onData((data) => { ... })`:
       - **Enter** (`'\r'`): If not ready or computing, ignore. Write `'\r\n'`.
         If `inputBuffer.trim()` is non-empty: push to history, set historyIndex,
         set `isComputing = true`, update status to "Computing...",
         `worker.postMessage({ type: 'evaluate', expr: inputBuffer })`.
         Else: write prompt. Reset `inputBuffer = ''`, `cursorPos = 0`.
       - **Backspace** (`'\x7f'`): If `cursorPos > 0`, splice inputBuffer,
         decrement cursorPos, call `redrawLine()`.
       - **Up arrow** (`'\x1b[A'`): Navigate history backward. Set inputBuffer
         to `history[historyIndex]`, set cursorPos, call `redrawLine()`.
       - **Down arrow** (`'\x1b[B'`): Navigate history forward. At end, clear to empty.
       - **Left arrow** (`'\x1b[D'`): If cursorPos > 0, decrement and move cursor left.
       - **Right arrow** (`'\x1b[C'`): If cursorPos < inputBuffer.length, increment and
         move cursor right.
       - **Printable chars** (`data >= ' '`): Insert at cursorPos, increment, redrawLine.
       - **Paste** (data.length > 1 and not escape sequence): Take only printable chars,
         replace any `\r` or `\n` with space, insert at cursorPos, redrawLine.

       `redrawLine()`: Write `'\r\x1b[K' + PROMPT + inputBuffer`, then move cursor
       back by `(inputBuffer.length - cursorPos)` if needed.

       Constant `PROMPT = 'qseries> '`.

    5. **Example dropdown:**
       ```javascript
       const EXAMPLES = {
         'rogers-ramanujan': [
           'G := sum(q^(n^2)/aqprod(q,q,n), n, 0, 8)',
           'prodmake(G, 50)',
         ],
         'product-conversion': [
           'p := 1/aqprod(q,q,50)',
           'prodmake(p, 50)',
         ],
         'theta-functions': [
           'theta2(q,100)',
           'theta3(q,100)',
           'theta4(q,100)',
         ],
         'relations': [
           'f1 := etaq(1,100)*etaq(7,100)',
           'f2 := etaq(2,100)*etaq(14,100)',
           'findhom([f1,f2],4,100)',
         ],
       };
       ```
       When "Run" button clicked: get selected example key, get command array.
       Execute commands sequentially — for each command, write `PROMPT + cmd + '\r\n'`
       to terminal, then send to worker. Wait for result before sending next.
       Use a queue: push all commands to a `pendingExampleCommands` array.
       After each result/error from worker, if queue is non-empty, pop and send next.

    6. **Loading overlay:**
       Show `#loading-overlay` by default. Hide it when Worker sends `{ type: 'ready' }`.
       The overlay contains a CSS spinner and "Loading qseries engine..." text.

    7. **Status indicator:**
       Update `#status` text content: "Loading..." → "Ready" → "Computing..." → "Ready".
       Add `.computing` class during computation for pulsing animation.
  </action>
  <verify>
    - `cat website/src/pages/playground.astro` exists and imports StarlightPage
    - `grep "Terminal" website/src/pages/playground.astro` confirms xterm.js import
    - `grep "Worker" website/src/pages/playground.astro` confirms Worker instantiation
    - `grep "EXAMPLES" website/src/pages/playground.astro` confirms example definitions
    - Run `cd website && npm run build` — build succeeds with no errors
    - The build output contains `playground/index.html`
  </verify>
  <done>
    playground.astro exists with StarlightPage wrapper, xterm.js terminal with dark
    teal theme, line-buffered input with history/backspace/arrow navigation, Worker
    integration with loading/computing states, example dropdown with 4 preloaded
    example sets, responsive terminal sizing via FitAddon.
  </done>
</task>

</tasks>

<verification>
1. `cd website && npm run build` completes without errors
2. Build output contains `dist/playground/index.html`
3. Sidebar contains a "Try it Online" link pointing to /playground/
4. No route conflict with old playground.md content doc
5. Worker script at public/wasm/qseries-worker.js contains proper init/evaluate message handling
6. Terminal theme uses dark background (#1a1a2e) with teal accent (#00bcd4) matching site theme
7. Example dropdown contains Rogers-Ramanujan, Product Conversion, Theta Functions, Finding Relations
8. Loading overlay exists with spinner and "Loading qseries engine..." text

Note: Full end-to-end testing (typing expressions, seeing results) requires the Wasm binary
to be present in website/public/wasm/. The Makefile `wasm-website` target handles this copy.
If the Wasm binary is not yet built (requires emsdk), the page structure and UI can still be
verified via `npm run build` — the terminal will show a loading state that never resolves,
which is expected without the Wasm files.
</verification>

<success_criteria>
1. `npm run build` in website/ succeeds
2. /playground/ route renders a StarlightPage with terminal UI
3. Worker script properly structured for init → ready → evaluate → result flow
4. Example dropdown has 4 example categories with runnable command sequences
5. Loading overlay hides when worker posts 'ready'
6. Terminal supports backspace, left/right arrows, up/down history navigation
7. No route conflicts, no broken sidebar links
</success_criteria>

<output>
After completion, create `.planning/phases/46-playground/46-01-SUMMARY.md`
</output>
