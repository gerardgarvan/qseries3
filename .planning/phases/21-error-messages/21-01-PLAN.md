---
phase: 21-error-messages
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/parser.h
autonomous: true

must_haves:
  truths:
    - "Parse errors show line and column (or offset) in the message"
    - "Parse errors show expected token or describe what was expected"
    - "Parse errors include actual character/token when useful (e.g. unexpected char)"
  artifacts:
    - path: src/parser.h
      provides: Token with offset, offsetToLineCol helper, Tokenizer assigns offset, Parser throws with position
  key_links:
    - from: Tokenizer
      to: Token
      via: "assign offset when returning each token"
      pattern: "Token\\(.*offset"
    - from: Parser expect/throw sites
      to: "current token"
      via: "use peek().offset or consume() result"
      pattern: "throw.*line|col|offset"
---

<objective>
Add position tracking to the parser so parse errors report line/column (or offset) and expected token. Tokenizer stores offset in each Token; parser throw sites include position in the message.

Purpose: QOL-07 — Parse errors show clearer diagnostics
Output: parser.h with position-aware errors
</objective>

<execution_context>
@C:/Users/ggarv/.claude/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/REQUIREMENTS.md (QOL-07)
@.planning/phases/21-error-messages/21-RESEARCH.md
@src/parser.h
</context>

<tasks>

<task type="auto">
  <name>Add position infrastructure to Token and Tokenizer</name>
  <files>src/parser.h</files>
  <action>
1. Add `size_t offset = 0` to struct Token (position in input where token starts).

2. Add inline helper:
   ```cpp
   inline void offsetToLineCol(const std::string& s, size_t off, int& line, int& col) {
       line = 1; col = 1;
       for (size_t i = 0; i < off && i < s.size(); ++i) {
           if (s[i] == '\n') { ++line; col = 1; } else ++col;
       }
   }
   ```

3. Tokenizer: ensure each `return Token(...)` sets `t.offset = start` (or `pos` before consume). For single-character tokens, use current `pos` as offset. Tokenizer has `input` and `pos`; pass offset into each Token constructor or assign after construction. Update Token constructor if needed to accept offset.

4. Token constructor: add optional `size_t off = 0` to Token(Kind k, std::string t, size_t off) or assign `t.offset = pos` before each return in next().
</action>
  <verify>Build succeeds; Token has offset field; offsetToLineCol compiles.</verify>
  <done>Token carries offset; offsetToLineCol computes line/col from offset.</done>
</task>

<task type="auto">
  <name>Update all parser throw sites to include position</name>
  <files>src/parser.h</files>
  <action>
1. Tokenizer throw sites (2): When throwing "parser: expected :=" and "parser: unexpected character", compute line/col via offsetToLineCol(input, pos, line, col), then throw std::runtime_error("parser: line L, col C: message"). For "unexpected character", append " '" + std::string(1,c) + "'" when c is printable.

2. Parser throw sites (4): expect(), parseSumCall (sum/add expects identifier), parsePrimary (expected primary). Add `std::string inputStr` member to Parser; in ctor store `inputStr = input` (before moving to Tokenizer). Use peek().offset and offsetToLineCol(inputStr, peek().offset, line, col) when throwing. Throw std::runtime_error("parser: line L, col C: message").

3. expect(Kind k): use "expected <token>" — map Kind to string (e.g. "')'", "'identifier'", "':='"). Or use a small helper kindToExpected(Kind).

4. Ensure expect() and parsePrimary get position from current token (peek()). For parseSumCall, the error "sum/add expects identifier" — position is the consumed token after COMMA, so use that token's offset.
</action>
  <verify>Run `echo "foo : bar" | ./qseries` and confirm error shows "line 1, col 6" or similar. Run `echo "sum(1, 2, 3)" | ./qseries` and confirm error includes position.</verify>
  <done>All 6 parse throw sites include "line L, col C" and expected/actual info.</done>
</task>

</tasks>

<verification>
- g++ -std=c++20 -O2 -o qseries main.cpp compiles
- Invalid input like `foo : 1` yields "parser: line 1, col 6: expected :="
- `sum(1, 2, 3)` yields error with position and "sum/add expects identifier"
- tests/acceptance.sh passes (no regression)
</verification>

<success_criteria>
- Parse errors show line and column
- Parse errors include expected token or descriptive message
- No change to parser API (parse() still returns StmtPtr)
</success_criteria>

<output>
After completion, create .planning/phases/21-error-messages/21-01-SUMMARY.md
</output>
