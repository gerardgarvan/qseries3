---
phase: 29-optional-arg-audit
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/repl.h, tests/acceptance-optional-args.sh, Makefile]
autonomous: true

must_haves:
  truths:
    - "series(f) and series(f,T) work; omitted T uses env.T"
    - "etaq(k) and etaq(k,T) work; omitted T uses env.T"
    - "qfactor(f), qfactor(f,T) work; omitted T uses env.T"
    - "jac2series(var), jac2series(var,T) work; omitted T uses env.T"
    - "checkprod(f), checkprod(f,T) work; omitted T uses env.T"
    - "checkmult(f), checkmult(f,T) work; omitted T uses env.T"
    - "findmaxind(L), findmaxind(L,topshift) work; omitted topshift uses 0"
  artifacts:
    - path: src/repl.h
      provides: "dispatchBuiltin with optional-arg variants"
  key_links:
    - from: dispatchBuiltin
      to: "etaq/checkprod/checkmult/findmaxind"
      via: "args.size() check; use env.T or default when 1 arg"
---

<objective>
Audit and fix optional-arg variants for REPL built-ins. Add 1-arg forms where missing: etaq(k), checkprod(f), checkmult(f), findmaxind(L). Ensure series, qfactor, jac2series use env.T when T omitted. REPL-OPTS-03.

Purpose: User can call functions with fewer args; omitted optional args use sensible defaults (env.T, topshift=0).
Output: Modified src/repl.h; acceptance-optional-args.sh.
</objective>

<execution_context>
@C:/Users/ggarv/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ggarv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Current dispatch (repl.h):
# - series(f), series(f,T): DONE (1 and 2 args)
# - etaq: 2 args (k,T) or 3 (q,k,T). MISSING: etaq(k) 1-arg -> etaq(q,k,T) with q,T from env
# - qfactor(f), qfactor(f,T): DONE
# - jac2series(var), jac2series(var,T): DONE
# - checkprod: 2 or 3 args. MISSING: checkprod(f) 1-arg -> checkprod(f,T)
# - checkmult: 2 or 3 args. MISSING: checkmult(f) 1-arg -> checkmult(f,T,false)
# - findmaxind: 2 args (L, topshift). MISSING: findmaxind(L) 1-arg -> findmaxind(L,0)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add etaq(k) 1-arg form</name>
  <files>src/repl.h</files>
  <action>
In dispatchBuiltin, etaq branch: add case for args.size() == 1.
When args.size() == 1: int k = static_cast&lt;int&gt;(evi(0)); return etaq(q, k, T);
Use env.q (Series) and env.T. q is available as Series::q(T) or env.env["q"]; T is env.T.
  </action>
  <verify>echo "etaq(1,20)" | ./dist/qseries 2>/dev/null | head -3; echo "etaq(1)" | ./dist/qseries 2>/dev/null | head -3 # both produce eta product output
  </verify>
  <done>etaq(1) and etaq(1,20) both work; etaq(1) uses env.T.</done>
</task>

<task type="auto">
  <name>Task 2: Add checkprod(f) and checkmult(f) 1-arg forms</name>
  <files>src/repl.h</files>
  <action>
In checkprod branch: add if (args.size() == 1) return checkprod(ev(0), T);
In checkmult branch: add if (args.size() == 1) return checkmult(ev(0), T, false);
T is env.T (from outer scope).
  </action>
  <verify>echo "set_trunc(30); checkprod(etaq(1,30))" | ./dist/qseries; echo "checkprod(etaq(1,30))" | ./dist/qseries # 1-arg form works with env.T
  </verify>
  <done>checkprod(f) and checkmult(f) use env.T when T omitted.</done>
</task>

<task type="auto">
  <name>Task 3: Add findmaxind(L) 1-arg form</name>
  <files>src/repl.h</files>
  <action>
In findmaxind branch: add case for args.size() == 1.
When args.size() == 1: auto L = evalListToSeries(args[0].get()); return findmaxind(L, 0);
topshift defaults to 0.
  </action>
  <verify>Assign list of series to var, then findmaxind(var) â€” should work with topshift=0.
  </verify>
  <done>findmaxind(L) works with topshift=0.</done>
</task>

<task type="auto">
  <name>Task 4: Add acceptance test and update help</name>
  <files>tests/acceptance-optional-args.sh, Makefile, src/repl.h</files>
  <action>
Create tests/acceptance-optional-args.sh that pipes commands and verifies:
- etaq(1) produces output (uses env.T)
- checkprod(etaq(1,30)) or checkprod(f) with 1 arg works
- checkmult(etaq(1,30)) or checkmult(f) with 1 arg works
- findmaxind(L) with 1 arg works (e.g. findmaxind([q,q^2]) or similar)

Update getHelpTable for etaq: "etaq(k) or etaq(k,T) or etaq(q,k,T)"
Update getHelpTable for checkprod, checkmult, findmaxind to show 1-arg variants.

Add Makefile target acceptance-optional-args.
  </action>
  <verify>make acceptance-optional-args passes
  </verify>
  <done>Acceptance test passes; help reflects optional args.</done>
</task>

</tasks>

<verification>
- [ ] series(f) works (already does)
- [ ] etaq(k) works with env.T
- [ ] qfactor(f) works (already does)
- [ ] jac2series(var) works (already does)
- [ ] checkprod(f), checkmult(f) work with env.T
- [ ] findmaxind(L) works with topshift=0
- [ ] All existing acceptance tests still pass
</verification>

<success_criteria>
- [ ] REPL-OPTS-03: All 2-arg and 3-arg variants work with omitted optional args
- [ ] etaq(k), checkprod(f), checkmult(f), findmaxind(L) added where missing
- [ ] acceptance-optional-args.sh passes
</success_criteria>

<output>
After completion, create `.planning/phases/29-optional-arg-audit/29-01-SUMMARY.md`
</output>
