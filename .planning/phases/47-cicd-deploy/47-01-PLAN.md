---
phase: 47-cicd-deploy
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/deploy.yml
  - website/public/_headers
autonomous: true
user_setup:
  - service: cloudflare-pages
    why: "Deploy static site with Wasm files to Cloudflare Pages"
    env_vars:
      - name: CLOUDFLARE_API_TOKEN
        source: "Cloudflare Dashboard → API Tokens → Create Token with 'Cloudflare Pages: Edit' permission"
      - name: CLOUDFLARE_ACCOUNT_ID
        source: "Cloudflare Dashboard → right sidebar shows Account ID"
    dashboard_config:
      - task: "Create Cloudflare Pages project (one-time)"
        location: "Run: npx wrangler pages project create qseries --production-branch=main"
      - task: "Add both secrets to GitHub repository"
        location: "GitHub repo → Settings → Secrets and variables → Actions → New repository secret"

must_haves:
  truths:
    - "GitHub Actions workflow triggers on push to main and on manual dispatch"
    - "Workflow builds Wasm via Emscripten, copies to website, builds Astro, deploys to Cloudflare Pages"
    - "Deployed site serves .wasm files with application/wasm Content-Type"
    - "Wasm assets have immutable cache headers for performance"
  artifacts:
    - path: ".github/workflows/deploy.yml"
      provides: "Complete CI/CD pipeline"
      contains: "build-and-deploy"
    - path: "website/public/_headers"
      provides: "Wasm MIME type and caching headers"
      contains: "application/wasm"
  key_links:
    - from: ".github/workflows/deploy.yml"
      to: "Makefile"
      via: "make wasm EMXX=em++ and make wasm-website"
      pattern: "make wasm"
    - from: ".github/workflows/deploy.yml"
      to: "website/package-lock.json"
      via: "npm ci in website/"
      pattern: "npm ci"
    - from: ".github/workflows/deploy.yml"
      to: "Cloudflare Pages"
      via: "wrangler pages deploy website/dist"
      pattern: "pages deploy"
    - from: "website/public/_headers"
      to: "website/dist/_headers"
      via: "Astro copies public/ contents into dist/ at build time"
      pattern: "/wasm/\\*.wasm"
---

<objective>
Create the GitHub Actions CI/CD workflow and Cloudflare Pages headers configuration for push-to-deploy of the qseries website with Wasm playground.

Purpose: Complete the v2.1 Website milestone by enabling automated deployment — push to main triggers Wasm compilation, site build, and Cloudflare Pages deployment.
Output: `.github/workflows/deploy.yml` (complete pipeline) and `website/public/_headers` (MIME type safety net)
</objective>

<execution_context>
@C:/Users/ggarv/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ggarv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/47-cicd-deploy/47-RESEARCH.md
@Makefile
@website/package.json
@website/astro.config.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create _headers file for Wasm MIME type and caching</name>
  <files>website/public/_headers</files>
  <action>
Create `website/public/_headers` with Cloudflare Pages header rules:

```
/wasm/*.wasm
  Content-Type: application/wasm
  Cache-Control: public, max-age=31536000, immutable

/wasm/*.js
  Cache-Control: public, max-age=31536000, immutable
```

This is a defense-in-depth measure — Cloudflare Pages likely auto-detects .wasm MIME type, but it's not explicitly documented. The `_headers` file is zero-cost insurance. Astro automatically copies everything from `public/` into `dist/` at build time, so this file will appear in the deployed output.

After creating, verify by running `npm run build` in `website/` and confirming `website/dist/_headers` exists with the correct content. The build must work on Windows natively (Node.js + npm are available natively, not via Cygwin).
  </action>
  <verify>
Run `npm run build` in website/ directory (Windows native npm). Confirm:
1. `website/dist/_headers` exists
2. Its content matches the source file
  </verify>
  <done>_headers file exists in website/public/ and is copied to dist/ during Astro build</done>
</task>

<task type="auto">
  <name>Task 2: Create GitHub Actions deploy workflow</name>
  <files>.github/workflows/deploy.yml</files>
  <action>
Create `.github/workflows/deploy.yml` with a single-job pipeline (all steps in one job to avoid artifact upload/download overhead — total build time well under 15 minutes).

The workflow must:

**Trigger:** `push` to `main` branch + `workflow_dispatch` (manual trigger)

**Job: `build-and-deploy`** on `ubuntu-latest` with permissions `contents: read`, `deployments: write`

**Steps (in order):**

1. `actions/checkout@v4`

2. **Setup Emscripten** — `mymindstorm/setup-emsdk@v14` with `version: 3.1.64` and `actions-cache-folder: emsdk-cache`. Pin 3.1.64 for reproducibility (a well-tested version; the project uses `-fwasm-exceptions` which needs modern emsdk).

3. **Verify Emscripten** — `run: em++ --version` (sanity check, catches cache corruption)

4. **Build Wasm** — `run: make wasm EMXX=em++` (the Makefile's `EMXX` variable defaults to `em++` but pass explicitly for clarity)

5. **Copy Wasm to website** — `run: make wasm-website` (copies `build/wasm/qseries.{js,wasm}` to `website/public/wasm/`)

6. **Setup Node.js** — `actions/setup-node@v4` with `node-version: 22`, `cache: npm`, `cache-dependency-path: website/package-lock.json`

7. **Install dependencies** — `run: npm ci` with `working-directory: website` (NOT `npm install` — `npm ci` ensures reproducible builds from lockfile)

8. **Build Astro site** — `run: npm run build` with `working-directory: website`

9. **Verify Wasm in output** — Run a verification step that checks `website/dist/wasm/qseries.wasm` and `website/dist/wasm/qseries.js` both exist. Use `test -f` for each file so the workflow fails fast if wasm-website was skipped or files are missing.

10. **Deploy to Cloudflare Pages** — `cloudflare/wrangler-action@v3` with `apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}`, `accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}`, `command: pages deploy website/dist --project-name=qseries`

Important details:
- Use `@v4` for checkout, setup-node, NOT `@4` (include the `v` prefix)
- Use `@v3` for wrangler-action (NOT `@3` — the `v` prefix is required since v3)
- Use `@v14` for setup-emsdk
- The `pages deploy` command (NOT `pages publish` which is deprecated)
- The project name is `qseries` — this becomes `qseries.pages.dev`
  </action>
  <verify>
1. `.github/workflows/deploy.yml` exists and is valid YAML
2. The file contains all 10 steps in correct order
3. Secrets are referenced as `${{ secrets.CLOUDFLARE_API_TOKEN }}` and `${{ secrets.CLOUDFLARE_ACCOUNT_ID }}`
4. Emscripten version is pinned to 3.1.64
5. `npm ci` is used (not `npm install`)
6. `pages deploy` is used (not `pages publish`)
  </verify>
  <done>GitHub Actions workflow file exists with complete Wasm → Site → Deploy pipeline, using correct action versions and secret references</done>
</task>

</tasks>

<verification>
1. `website/public/_headers` exists with correct Content-Type and Cache-Control rules
2. `website/dist/_headers` is produced after `npm run build` in website/
3. `.github/workflows/deploy.yml` exists with valid YAML structure
4. Workflow triggers on push to main and workflow_dispatch
5. Build sequence is: checkout → emsdk → wasm → wasm-website → node → npm ci → astro build → verify wasm → deploy
6. All action versions use `v` prefix: @v4, @v14, @v3
7. Secrets referenced correctly for Cloudflare API token and account ID
</verification>

<success_criteria>
- Both files exist and contain correct configuration
- Astro build picks up _headers from public/ into dist/
- Workflow YAML is structurally valid
- Once the user configures Cloudflare project + GitHub secrets, pushing to main will trigger a complete build-and-deploy cycle
</success_criteria>

<output>
After completion, create `.planning/phases/47-cicd-deploy/47-01-SUMMARY.md`
</output>
